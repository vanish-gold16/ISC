<div th:fragment="header" xmlns:th="http://www.thymeleaf.org">
<header class="topbar">
    <style>
        .profile-menu {
            position: relative;
        }

        .profile-menu > summary {
            list-style: none;
            cursor: pointer;
        }

        .profile-menu > summary::-webkit-details-marker {
            display: none;
        }

        .profile-menu__panel {
            position: absolute;
            right: 0;
            top: calc(100% + 8px);
            min-width: 180px;
            background: #fff;
            border: 1px solid #d9e2f2;
            border-radius: 12px;
            box-shadow: 0 14px 34px rgba(15, 23, 42, 0.12);
            padding: 6px;
            z-index: 30;
            display: grid;
            gap: 2px;
        }

        .profile-menu__item {
            display: block;
            width: 100%;
            text-align: left;
            border: 0;
            background: transparent;
            color: #0f172a;
            padding: 10px 12px;
            border-radius: 8px;
            text-decoration: none;
            cursor: pointer;
            font: inherit;
        }

        .profile-menu__item:hover {
            background: #f1f6ff;
        }

        .notify-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 14px;
            border: 1px solid #d9e2f2;
            background: #fff;
            cursor: pointer;
        }

        .notify-btn:hover {
            background: #f1f6ff;
        }

        .notify-btn__icon {
            width: 28px;
            height: 28px;
            object-fit: contain;
            display: block;
        }

        .notify-menu {
            position: relative;
        }

        .notify-menu__dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            width: min(380px, calc(100vw - 24px));
            max-height: 360px;
            overflow: auto;
            background: #fff;
            border: 1px solid #d9e2f2;
            border-radius: 12px;
            box-shadow: 0 14px 34px rgba(15, 23, 42, 0.12);
            padding: 8px;
            z-index: 30;
            display: none;
        }

        .notify-menu:hover .notify-menu__dropdown,
        .notify-menu:focus-within .notify-menu__dropdown {
            display: block;
        }

        .notify-menu__head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 6px 8px 10px;
            border-bottom: 1px solid #e8eef9;
            margin-bottom: 4px;
        }

        .notify-menu__title {
            margin: 0;
            font-size: 14px;
            font-weight: 700;
            color: #0f172a;
        }

        .notify-menu__view-all {
            color: #1d4ed8;
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
        }

        .notify-menu__view-all:hover {
            text-decoration: underline;
        }

        .notify-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 8px;
            border-radius: 8px;
            text-decoration: none;
            color: #0f172a;
        }

        .notify-item__avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .notify-item__content {
            flex: 1;
            min-width: 0;
        }

        .notify-item:hover {
            background: #f1f6ff;
        }

        .notify-item.is-unread {
            background: #eef5ff;
        }

        .notify-item__title {
            margin: 0;
            font-size: 13px;
            font-weight: 700;
        }

        .notify-item__body {
            margin: 2px 0 0;
            color: #475569;
            font-size: 12px;
        }

        .notify-item__date {
            margin: 6px 0 0;
            color: #64748b;
            font-size: 11px;
        }

        .notify-empty {
            color: #64748b;
            font-size: 13px;
            padding: 10px 8px;
        }

        .notify-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 18px;
            height: 18px;
            border-radius: 999px;
            background: #dc2626;
            color: #fff;
            border: 2px solid #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            padding: 0 5px;
            line-height: 1;
        }

        .brand__logo-img {
            width: 28px;
            height: 28px;
            object-fit: contain;
            display: block;
        }
    </style>
    <div class="topbar__inner container">
        <a class="brand" href="/home">
            <span class="brand__logo-stack" aria-hidden="true">
                <img class="brand__logo-img"
                     th:src="@{/images/logo.png}"
                     src="/images/logo.png"
                     alt="" />
            </span>
            <span class="brand__text">International Student Community</span>
        </a>

        <div class="topbar__search" aria-hidden="false">
            <img class="search__icon"
                 th:src="@{/images/private/sidebar-icons/search.png}"
                 src="/images/private/sidebar-icons/search.png"
                 alt=""
                 aria-hidden="true" />
            <input
                class="search"
                type="search"
                placeholder="Search people, posts, communities..."
                aria-label="Search"
            />
        </div>

        <div class="topbar__actions">
            <div class="notify-menu">
                <a class="notify-btn" th:href="@{/notifications}" href="/notifications" aria-label="Notifications">
                    <img class="notify-btn__icon"
                         th:src="@{/images/private/header/notifications.png}"
                         src="/images/private/header/notifications.png"
                         alt="" />
                    <span class="notify-badge"
                          th:if="${unreadNotifications != null and unreadNotifications > 0}"
                          th:text="${unreadNotifications > 99 ? '99+' : unreadNotifications}">1</span>
                </a>

                <div class="notify-menu__dropdown" role="menu" aria-label="Latest notifications">

                    <div th:if="${notificationsPreview != null and !#lists.isEmpty(notificationsPreview)}">
                        <div class="notify-item"
                           th:classappend="${n.readAt == null} ? ' is-unread' : ''"
                           th:each="n : ${#lists.size(notificationsPreview) > 5 ? notificationsPreview.subList(0,5) : notificationsPreview}">
                            <a th:if="${n.sender != null}"
                               th:href="@{/profile/{id}(id=${n.sender.id})}">
                                <img class="notify-item__avatar"
                                     th:src="${n.sender.profile != null and n.sender.profile.avatarUrl != null} ? ${n.sender.profile.avatarUrl} : '/images/private/profile/common-profile.png'"
                                     alt="" />
                            </a>
                            <img th:if="${n.sender == null}"
                                 class="notify-item__avatar"
                                 src="/images/private/profile/common-profile.png"
                                 alt="" />
                            <div class="notify-item__content">
                                <p class="notify-item__title">
                                    <a th:if="${n.sender != null}"
                                       th:href="@{/profile/{id}(id=${n.sender.id})}"
                                       th:text="${n.sender.username}"
                                       style="color: #1d4ed8; text-decoration: none; font-weight: 700;">User</a>
                                    <span th:text="${n.title} ?: 'Notification'">Notification</span>
                                </p>
                                <p class="notify-item__body" th:text="${n.body} ?: 'Open notifications to view details.'">Open notifications to view details.</p>
                                <p class="notify-item__date"
                                   th:with="now=${T(java.time.LocalDateTime).now()},
                                            diff=${T(java.time.Duration).between(n.createdAt, now)}"
                                   th:text="${diff.toMinutes() < 1} ? 'just now' :
                                             (${diff.toMinutes() < 60} ? ${diff.toMinutes()} + ' min ago' :
                                             (${diff.toHours() < 24} ? ${diff.toHours()} + ' hours ago' :
                                             (${diff.toDays() < 7} ? ${diff.toDays()} + ' days ago' :
                                             ${#temporals.format(n.createdAt, 'dd MMM yyyy')})))">
                                </p>
                            </div>
                        </div>
                    </div>

                    <p class="notify-empty" th:if="${notificationsPreview == null or #lists.isEmpty(notificationsPreview)}">
                        No notifications yet.
                    </p>
                </div>
            </div>

            <details class="profile-menu">
                <summary class="profile" aria-label="Open profile menu">
                    <img class="profile__img"
                         th:src="${userAvatarUrl} ?: '/images/private/profile/common-profile.png'"
                         alt="" />
                </summary>

                <nav class="profile-menu__panel" aria-label="Profile menu">
                    <a class="profile-menu__item" th:href="@{/profile/edit}">Edit profile</a>
                    <a class="profile-menu__item" th:href="@{/settings}">Settings</a>
                    <form th:action="@{/logout}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button class="profile-menu__item" type="submit">Logout</button>
                    </form>
                </nav>
            </details>
        </div>

    </div>
</header>
</div>
