<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" th:href="@{/favicon.png}" href="/favicon.png" />

    <title th:text="${title} ?: 'ISC | Notifications'">ISC | Notifications</title>

    <link rel="stylesheet" href="/css/private/home.css" />
    <style>
        .notifications-page {
            display: grid;
            grid-template-columns: minmax(0, 1fr) 320px;
            gap: 18px;
            padding: 18px 0 24px;
        }

        .notifications {
            min-width: 0;
            display: grid;
            gap: 14px;
        }

        .notifications-head {
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .notifications-head h1 {
            margin: 0;
            font-size: 24px;
            line-height: 1.2;
        }

        .notifications-sub {
            margin: 4px 0 0;
            color: var(--muted);
        }

        /* Tabs */
        .notif-tabs {
            display: flex;
            gap: 4px;
            border-bottom: 2px solid var(--border);
            margin-bottom: 4px;
        }

        .notif-tab {
            padding: 8px 18px;
            font-size: 14px;
            font-weight: 600;
            color: var(--muted);
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            transition: color .15s;
        }

        .notif-tab.active {
            color: #1d4ed8;
            border-bottom-color: #1d4ed8;
        }

        .notif-tab:hover:not(.active) {
            background: #f1f6ff;
            color: #0f172a;
        }

        .notif-tab-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            border-radius: 999px;
            background: #dc2626;
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            margin-left: 6px;
        }

        .notif-panel { display: none; }
        .notif-panel.active { display: block; }

        /* List */
        .notifications-list {
            display: grid;
            gap: 10px;
            margin-top: 12px;
        }

        .notification-item {
            padding: 14px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .notification-item__avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .notification-item__content {
            flex: 1;
            min-width: 0;
            display: grid;
            gap: 8px;
        }

        .notification-item.is-unread {
            border-color: rgba(37, 99, 235, 0.45);
            box-shadow: 0 14px 34px rgba(37, 99, 235, 0.12);
            background: #eef5ff;
        }

        /* Read items — серые */
        .notification-item.is-read {
            opacity: 0.6;
            background: #f8fafc;
        }

        .notification-top {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }

        .notification-title {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
        }

        .notification-date {
            color: var(--muted);
            font-size: 13px;
            white-space: nowrap;
        }

        .notification-body { margin: 0; }

        .notification-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }

        .notification-type {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #fff;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .notification-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge-following {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 999px;
            background: #dcfce7;
            color: #166534;
            font-weight: 600;
        }

        @media (max-width: 960px) {
            .notifications-page { grid-template-columns: 1fr; }
        }
    </style>
</head>

<body>
<header th:replace="~{private/blocks/private-header :: header}"></header>

<main class="container notifications-page">
    <section class="notifications">
        <header class="card notifications-head">
            <div>
                <h1>Notifications</h1>
                <p class="notifications-sub">
                    <span th:text="${unreadCount} ?: 0">0</span> unread
                </p>
            </div>
            <form th:action="@{/notifications/read-all}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button class="btn btn--ghost btn--sm" type="submit">Mark all as read</button>
            </form>
        </header>

        <!-- Tabs -->
        <div class="card" style="padding: 12px 16px 0;">
            <div class="notif-tabs">
                <button class="notif-tab active" onclick="switchTab('unread', this)">
                    Unread
                    <span class="notif-tab-badge"
                          th:if="${unreadCount > 0}"
                          th:text="${unreadCount}">0</span>
                </button>
                <button class="notif-tab" onclick="switchTab('read', this)">Read</button>
            </div>

            <!-- Unread panel -->
            <div id="panel-unread" class="notif-panel active">
                <div class="notifications-list"
                     th:if="${unreadNotifications != null and !#lists.isEmpty(unreadNotifications)}">
                    <th:block th:each="n : ${unreadNotifications}">
                        <article class="card notification-item is-unread">
                            <!-- Avatar — клик читает уведомление и идёт на профиль -->
                            <a th:if="${n.sender != null}"
                               th:href="@{/notifications/{id}/open(id=${n.notificationId})}">
                                <img class="notification-item__avatar"
                                     th:src="${n.sender.profile != null and n.sender.profile.avatarUrl != null}
                                             ? ${n.sender.profile.avatarUrl}
                                             : '/images/private/profile/common-profile.png'"
                                     alt="" />
                            </a>
                            <img th:if="${n.sender == null}"
                                 class="notification-item__avatar"
                                 src="/images/private/profile/common-profile.png" alt="" />

                            <div class="notification-item__content">
                                <div class="notification-top">
                                    <h2 class="notification-title" th:text="${n.title} ?: 'Notification'">Notification</h2>
                                    <time class="notification-date"
                                          th:with="now=${T(java.time.LocalDateTime).now()},
                                                   diff=${T(java.time.Duration).between(n.createdAt, now)}"
                                          th:text="${diff.toMinutes() < 1} ? 'just now' :
                                                    (${diff.toMinutes() < 60} ? ${diff.toMinutes()} + ' min ago' :
                                                    (${diff.toHours() < 24} ? ${diff.toHours()} + ' hours ago' :
                                                    (${diff.toDays() < 7} ? ${diff.toDays()} + ' days ago' :
                                                    ${#temporals.format(n.createdAt, 'dd MMM yyyy')})))">-</time>
                                </div>

                                <p class="notification-body muted">
                                    <a th:if="${n.sender != null}"
                                       th:href="@{/notifications/{id}/open(id=${n.notificationId})}"
                                       th:text="${n.sender.username}"
                                       style="color: #1d4ed8; text-decoration: none; font-weight: 600;">User</a>
                                    <span th:text="${n.body} ?: 'You have a new update.'">body</span>
                                </p>

                                <div class="notification-meta">
                                    <span class="notification-type" th:text="${n.type} ?: 'SYSTEM'">SYSTEM</span>

                                    <div class="notification-actions">
                                        <!-- Accept friend request -->
                                        <form th:if="${n.type != null
                                              and n.type.name() == 'FRIEND_REQUEST'
                                              and n.sender != null}"
                                              th:action="@{/notifications/{id}/accept-friend-request(id=${n.notificationId})}"
                                              method="post" style="display:inline;">
                                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                            <button class="btn btn--primary btn--sm" type="submit">Accept friend request</button>
                                        </form>

                                        <!-- Follow back -->
                                        <form th:if="${n.type != null
                                              and n.type.name() == 'FOLLOW'
                                              and n.sender != null
                                              and !#sets.contains(followingIds, n.sender.id)}"
                                              th:action="@{/notifications/{id}/follow-back(id=${n.notificationId})}"
                                              method="post" style="display:inline;">
                                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                            <button class="btn btn--primary btn--sm" type="submit">Follow back</button>
                                        </form>

                                        <span th:if="${n.type != null
                                              and n.type.name() == 'FOLLOW'
                                              and n.sender != null
                                              and #sets.contains(followingIds, n.sender.id)}"
                                              class="badge-following">Following</span>

                                        <form th:action="@{/notifications/{id}/read(id=${n.notificationId})}"
                                              method="post" style="display: inline;">
                                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                            <button class="btn btn--ghost btn--sm" type="submit">Mark as read</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </article>
                    </th:block>
                </div>

                <div class="card empty"
                     th:if="${unreadNotifications == null or #lists.isEmpty(unreadNotifications)}"
                     style="margin-top: 12px;">
                    <h3>No unread notifications</h3>
                    <p class="muted">You're all caught up!</p>
                </div>
            </div>

            <!-- Read panel -->
            <div id="panel-read" class="notif-panel">
                <div class="notifications-list"
                     th:if="${readNotifications != null and !#lists.isEmpty(readNotifications)}">
                    <th:block th:each="n : ${readNotifications}">
                        <article class="card notification-item is-read">
                            <a th:if="${n.sender != null}"
                               th:href="@{/profile/{id}(id=${n.sender.id})}">
                                <img class="notification-item__avatar"
                                     th:src="${n.sender.profile != null and n.sender.profile.avatarUrl != null}
                                             ? ${n.sender.profile.avatarUrl}
                                             : '/images/private/profile/common-profile.png'"
                                     alt="" />
                            </a>
                            <img th:if="${n.sender == null}"
                                 class="notification-item__avatar"
                                 src="/images/private/profile/common-profile.png" alt="" />

                            <div class="notification-item__content">
                                <div class="notification-top">
                                    <h2 class="notification-title" th:text="${n.title} ?: 'Notification'">Notification</h2>
                                    <time class="notification-date"
                                          th:with="now=${T(java.time.LocalDateTime).now()},
                                                   diff=${T(java.time.Duration).between(n.createdAt, now)}"
                                          th:text="${diff.toMinutes() < 1} ? 'just now' :
                                                    (${diff.toMinutes() < 60} ? ${diff.toMinutes()} + ' min ago' :
                                                    (${diff.toHours() < 24} ? ${diff.toHours()} + ' hours ago' :
                                                    (${diff.toDays() < 7} ? ${diff.toDays()} + ' days ago' :
                                                    ${#temporals.format(n.createdAt, 'dd MMM yyyy')})))">-</time>
                                </div>

                                <p class="notification-body muted">
                                    <a th:if="${n.sender != null}"
                                       th:href="@{/profile/{id}(id=${n.sender.id})}"
                                       th:text="${n.sender.username}"
                                       style="color: #64748b; text-decoration: none; font-weight: 600;">User</a>
                                    <span th:text="${n.body} ?: 'You have a new update.'">body</span>
                                </p>

                                <div class="notification-meta">
                                    <span class="notification-type" th:text="${n.type} ?: 'SYSTEM'">SYSTEM</span>

                                    <!-- Показываем кнопки действий даже для прочитанных -->
                                    <div class="notification-actions">
                                        <span th:if="${n.type != null
                                              and n.type.name() == 'FOLLOW'
                                              and n.sender != null
                                              and #sets.contains(followingIds, n.sender.id)}"
                                              class="badge-following">Following</span>

                                        <form th:if="${n.type != null
                                              and n.type.name() == 'FOLLOW'
                                              and n.sender != null
                                              and !#sets.contains(followingIds, n.sender.id)}"
                                              th:action="@{/notifications/{id}/follow-back(id=${n.notificationId})}"
                                              method="post" style="display:inline;">
                                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                            <button class="btn btn--primary btn--sm" type="submit">Follow back</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </article>
                    </th:block>
                </div>

                <div class="card empty"
                     th:if="${readNotifications == null or #lists.isEmpty(readNotifications)}"
                     style="margin-top: 12px;">
                    <h3>No read notifications yet</h3>
                    <p class="muted">Read notifications will appear here.</p>
                </div>
            </div>
        </div>
    </section>

    <aside th:replace="~{/private/blocks/right-sidebar :: rightSidebar('notifications')}"></aside>
</main>

<footer th:replace="~{private/blocks/private-footer :: footer}"></footer>

<script>
    function switchTab(name, btn) {
        document.querySelectorAll('.notif-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.notif-panel').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('panel-' + name).classList.add('active');
    }
</script>
</body>
</html>