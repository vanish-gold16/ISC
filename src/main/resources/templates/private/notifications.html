<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" th:href="@{/favicon.png}" href="/favicon.png" />

    <title th:text="${title} ?: 'ISC | Notifications'">ISC | Notifications</title>

    <link rel="stylesheet" href="/css/private/home.css" />
    <style>
        .notifications-page {
            display: grid;
            grid-template-columns: minmax(0, 1fr) 320px;
            gap: 18px;
            padding: 18px 0 24px;
        }

        .notifications {
            min-width: 0;
            display: grid;
            gap: 14px;
        }

        .notifications-head {
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .notifications-head h1 {
            margin: 0;
            font-size: 24px;
            line-height: 1.2;
        }

        .notifications-sub {
            margin: 4px 0 0;
            color: var(--muted);
        }

        .notifications-list {
            display: grid;
            gap: 10px;
        }

        .notification-item {
            padding: 14px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .notification-item__avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .notification-item__content {
            flex: 1;
            min-width: 0;
            display: grid;
            gap: 8px;
        }

        .notification-item.is-unread {
            border-color: rgba(37, 99, 235, 0.45);
            box-shadow: 0 14px 34px rgba(37, 99, 235, 0.12);
            background: #eef5ff;
        }

        .notification-top {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }

        .notification-title {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
        }

        .notification-date {
            color: var(--muted);
            font-size: 13px;
            white-space: nowrap;
        }

        .notification-body {
            margin: 0;
        }

        .notification-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }

        .notification-type {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #fff;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .notification-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge-following {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 999px;
            background: #dcfce7;
            color: #166534;
            font-weight: 600;
        }

        @media (max-width: 960px) {
            .notifications-page {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
<header th:replace="~{private/blocks/private-header :: header}"></header>

<main class="container notifications-page">
    <section class="notifications">
        <header class="card notifications-head">
            <div>
                <h1>Notifications</h1>
                <p class="notifications-sub">
                    <span th:text="${unreadCount} ?: 0">0</span>
                    unread updates
                </p>
            </div>

            <form th:action="@{/notifications/read-all}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button class="btn btn--ghost btn--sm" type="submit">Mark all as read</button>
            </form>
        </header>

        <div class="notifications-list" th:if="${notifications != null and !#lists.isEmpty(notifications)}">
            <article class="card notification-item"
                     th:classappend="${n.readAt == null} ? ' is-unread' : ''"
                     th:each="n : ${notifications}">

                <!-- Avatar -->
                <a th:if="${n.sender != null}"
                   th:href="@{/profile/{id}(id=${n.sender.id})}">
                    <img class="notification-item__avatar"
                         th:src="${n.sender.profile != null and n.sender.profile.avatarUrl != null} ? ${n.sender.profile.avatarUrl} : '/images/private/profile/common-profile.png'"
                         alt="" />
                </a>
                <img th:if="${n.sender == null}"
                     class="notification-item__avatar"
                     src="/images/private/profile/common-profile.png"
                     alt="" />

                <div class="notification-item__content">
                    <div class="notification-top">
                        <h2 class="notification-title" th:text="${n.title} ?: 'Notification'">Notification</h2>
                        <time class="notification-date"
                              th:with="now=${T(java.time.LocalDateTime).now()},
                                       diff=${T(java.time.Duration).between(n.createdAt, now)}"
                              th:text="${diff.toMinutes() < 1} ? 'just now' :
                                        (${diff.toMinutes() < 60} ? ${diff.toMinutes()} + ' min ago' :
                                        (${diff.toHours() < 24} ? ${diff.toHours()} + ' hours ago' :
                                        (${diff.toDays() < 7} ? ${diff.toDays()} + ' days ago' :
                                        ${#temporals.format(n.createdAt, 'dd MMM yyyy')})))">-</time>
                    </div>

                    <p class="notification-body muted">
                        <a th:if="${n.sender != null}"
                           th:href="@{/profile/{id}(id=${n.sender.id})}"
                           th:text="${n.sender.username}"
                           style="color: #1d4ed8; text-decoration: none; font-weight: 600;">User</a>
                        <span th:text="${n.body} ?: 'You have a new update.'">wants to be your friend</span>
                    </p>

                    <div class="notification-meta">
                        <span class="notification-type" th:text="${n.type} ?: 'SYSTEM'">SYSTEM</span>

                        <div class="notification-actions">


                            <span th:if="${n.type != null and n.type.name() == 'FOLLOW' and n.sender != null and #sets.contains(followingIds, n.sender.id)}"
                                  class="badge-following">Following</span>

                            <form th:if="${n.readAt == null}"
                                  th:action="@{/notifications/{id}/read(id=${n.notificationId})}"
                                  method="post"
                                  style="display: inline;">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <button class="btn btn--ghost btn--sm" type="submit">Mark as read</button>
                            </form>
                        </div>
                    </div>
                </div>
            </article>
        </div>

        <div class="card empty" th:if="${notifications == null or #lists.isEmpty(notifications)}">
            <h3>No notifications yet</h3>
            <p class="muted">When someone interacts with your profile, updates will appear here.</p>
        </div>
    </section>

    <aside th:replace="~{/private/blocks/right-sidebar :: rightSidebar('notifications')}"></aside>
</main>

<footer th:replace="~{private/blocks/private-footer :: footer}"></footer>
</body>
</html>
